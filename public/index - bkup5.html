<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Point</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <style>
        body {
            padding: 20px;
        }
        .container {
            margin-top: 20px;
        }
        .table-container {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Knowledge Point</h1>
        <nav class="nav nav-pills nav-fill">
            <a class="nav-item nav-link active" href="#" onclick="showEnroll()">Registration</a>
            <a class="nav-item nav-link" href="#" onclick="showUpdate()">Update</a>
            <a class="nav-item nav-link" href="#" onclick="showAddPayment()">Payment</a>
            <a class="nav-item nav-link" href="#" onclick="showExit()">Delete</a>
        </nav>

        <div id="enroll" class="table-container">
            <h2>Enroll a New Student</h2>
            <form id="enrollForm">
		<div class="form-group">
		    <label for="enrollName">Name</label>
		    <input type="text" class="form-control" id="enrollName" placeholder="Enter the name of Student" required>
		</div>
		
		<div class="form-group">
		    <label for="enrollClass">Class <span class="badge badge-info">Select the standard</span></label>
		    <select class="form-control" id="enrollClass" required>
		        <option value="">Select Class</option>
		        <option value="1">1</option>
		        <option value="2">2</option>
		        <option value="3">3</option>
		        <option value="4">4</option>
		        <option value="5">5</option>
		        <option value="6">6</option>
		        <option value="7">7</option>
		        <option value="8">8</option>
		        <option value="9">9</option>
		        <option value="10">10</option>
		        <option value="11">11</option>
		        <option value="12">12</option>
		    </select>
		</div>

<!-- Include Bootstrap CSS for badge styling -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">


<!-- Optional JavaScript for tooltip functionality -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    })
</script>

<!-- Include Bootstrap CSS and JS for tooltip -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>

                <div class="form-group">
                    <label for="enrollSchool">School</label>
                    <select class="form-control" id="enrollSchool" required>
                        <option value="KCPS">KCPS</option>
                        <option value="DPS">DPS</option>
                        <option value="Inventure">Inventure</option>
                        <option value="Atmanand">Atmanand</option>
                        <option value="Others">Others</option>
                    </select>
                </div>
				<div class="form-group">
				    <label for="enrollDate">Enroll Date <span class="badge badge-info" data-toggle="tooltip" title="Select the date from calendar, if needed">Select from calendar</span></label>
				    <input type="date" class="form-control" id="enrollDate" required>
				</div>
				

				<script>
				    document.addEventListener('DOMContentLoaded', function () {
				        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-toggle="tooltip"]'))
				        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
				            return new bootstrap.Tooltip(tooltipTriggerEl)
				        })
				    })
				</script>

                <div class="form-group">
                    <label for="enrollFee">Fee Amount</label>
                    <input type="number" class="form-control" id="enrollFee" value="1000" required>
                </div>

				<!-- Include jQuery -->
				<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
				
				<div class="form-group">
				    <label for="enrollMonth">Month</label>
				    <select class="form-control" id="enrollMonth" required>
				        <!-- Options will be added by JavaScript -->
				    </select>
				</div>
				
				<script>
				    $(function() {
				        // List of month names
				        const months = [
				            "January", "February", "March", "April", "May", "June",
				            "July", "August", "September", "October", "November", "December"
				        ];
				
				        // Get the current month index
				        const now = new Date();
				        const currentMonthIndex = now.getMonth();
				
				        // Get the select element
				        const selectElement = $("#enrollMonth");
				
				        // Populate the select element with month options
				        months.forEach((month, index) => {
				            const option = $("<option></option>").val(month).text(month);
				            // Set the default selected option based on the current month
				            if (index === currentMonthIndex) {
				                option.prop("selected", true);
				            }
				            selectElement.append(option);
				        });
				    });
				</script>

				

                <div class="form-group">
                    <label for="enrollPayment">Payment Received</label>
                    <select class="form-control" id="enrollPayment" required>
                        <option value="No">No</option>
                        <option value="Yes">Yes</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Enroll</button>
            </form>
            <div id="enrollMessage" class="mt-3"></div>
        </div>

        <div id="update" class="table-container" style="display: none;">
            <h2>Update Student Details</h2>
            <form id="updateSearchForm">
                <div class="form-group">
                    <label for="updateSearch">Search by Name, Class, or School</label>
                    <input type="text" class="form-control" id="updateSearch" required>
                </div>
                <button type="submit" class="btn btn-primary">Search</button>
            </form>
            <div id="updateResult" class="mt-3"></div>
        </div>

        <div id="payment" class="table-container" style="display: none;">
            <h2>Add Payment Option</h2>
            <form id="paymentSearchForm">
                <div class="form-group">
                    <label for="paymentSearch">Search by Name, Class, or School</label>
                    <input type="text" class="form-control" id="paymentSearch" required>
                </div>
                <button type="submit" class="btn btn-primary">Search</button>
            </form>
            <div id="paymentResult" class="mt-3"></div>
        </div>

        <div id="exit" class="table-container" style="display: none;">
            <h2>Exit Student</h2>
            <form id="exitSearchForm">
                <div class="form-group">
                    <label for="exitSearch">Search by Name, Class, or School</label>
                    <input type="text" class="form-control" id="exitSearch" required>
                </div>
                <button type="submit" class="btn btn-primary">Search</button>
            </form>
            <div id="exitResult" class="mt-3"></div>
        </div>
    </div>

    <script>
        function showEnroll() {
            document.getElementById('enroll').style.display = 'block';
            document.getElementById('update').style.display = 'none';
            document.getElementById('payment').style.display = 'none';
            document.getElementById('exit').style.display = 'none';
        }

        function showUpdate() {
            document.getElementById('enroll').style.display = 'none';
            document.getElementById('update').style.display = 'block';
            document.getElementById('payment').style.display = 'none';
            document.getElementById('exit').style.display = 'none';
        }

        function showAddPayment() {
            document.getElementById('enroll').style.display = 'none';
            document.getElementById('update').style.display = 'none';
            document.getElementById('payment').style.display = 'block';
            document.getElementById('exit').style.display = 'none';
        }

        function showExit() {
            document.getElementById('enroll').style.display = 'none';
            document.getElementById('update').style.display = 'none';
            document.getElementById('payment').style.display = 'none';
            document.getElementById('exit').style.display = 'block';
        }

        document.getElementById('enrollForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const name = document.getElementById('enrollName').value;
            const studentClass = document.getElementById('enrollClass').value;
            const school = document.getElementById('enrollSchool').value;
            const date = document.getElementById('enrollDate').value;
            const fee = document.getElementById('enrollFee').value;
            const month = document.getElementById('enrollMonth').value;
            const payment = document.getElementById('enrollPayment').value;

            const response = await fetch('/enroll', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name, studentClass, school, date, fee, month, payment }),
            });

            const result = await response.json();
            document.getElementById('enrollMessage').textContent = result.message;
        });

        document.getElementById('updateSearchForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const query = document.getElementById('updateSearch').value;

            const response = await fetch(`/search?query=${query}`);
            const result = await response.json();
            displaySearchResults('updateResult', result);
        });

        document.getElementById('paymentSearchForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const query = document.getElementById('paymentSearch').value;

            const response = await fetch(`/search?query=${query}`);
            const result = await response.json();
            displaySearchResults('paymentResult', result);
        });

        document.getElementById('exitSearchForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const query = document.getElementById('exitSearch').value;

            const response = await fetch(`/search?query=${query}`);
            const result = await response.json();
            displaySearchResults('exitResult', result);
        });

        function displaySearchResults(containerId, results) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (results.length > 1) {
                const table = document.createElement('table');
                table.classList.add('table', 'table-striped');
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                ['Student ID', 'Name', 'Class', 'School', 'Enroll Date', 'Fee', 'Month', 'Payment', "Student Left", 'Action'].forEach(text => {
                    const th = document.createElement('th');
                    th.textContent = text;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                table.appendChild(thead);

                const tbody = document.createElement('tbody');
                results.forEach(result => {
                    const row = document.createElement('tr');
                    Object.values(result).forEach(value => {
                        const td = document.createElement('td');
                        td.textContent = value;
                        row.appendChild(td);
                    });
                    const actionTd = document.createElement('td');
                    const selectButton = document.createElement('button');
                    selectButton.textContent = 'Select';
                    selectButton.classList.add('btn', 'btn-primary');
                    selectButton.addEventListener('click', () => editRecord(containerId, result));
                    actionTd.appendChild(selectButton);
                    row.appendChild(actionTd);
                    tbody.appendChild(row);
                });
                table.appendChild(tbody);
                container.appendChild(table);
            } else if (results.length === 1) {
                editRecord(containerId, results[0]);
            } else {
                container.textContent = 'No records found.';
            }
        }

function editRecord(containerId, record) {
    const container = document.getElementById(containerId);
    
    let buttonLabel = "Save";
    let buttonClass = "btn btn-primary";
    
    if (containerId === 'exitResult') {
        buttonLabel = "Confirm Delete";
        buttonClass = "btn btn-danger";
    } else if (containerId === 'paymentResult') {
        buttonLabel = "Confirm Payment";
        buttonClass = "btn btn-success";
    }

    let fields = `
        <form id="${containerId}Form">
            <div class="form-group">
                <label for="${containerId}Name">Name</label>
                <input type="text" class="form-control" id="${containerId}Name" value="${record.name}" ${containerId === 'paymentResult' || containerId === 'exitResult'  ? 'readonly' : 'required'}>
            </div>
            <div class="form-group">
                <label for="${containerId}Class">Class</label>
                <select class="form-control" id="${containerId}Class" ${containerId === 'paymentResult' || containerId === 'exitResult'  ? 'disabled' : 'required'}>
                    ${Array.from({ length: 12 }, (_, i) => i + 1).map(value =>
                        `<option value="${value}" ${record.studentClass === value.toString() ? 'selected' : ''}>${value}</option>`).join('')}
                </select>
            </div>
            <div class="form-group">
                <label for="${containerId}School">School</label>
                <select class="form-control" id="${containerId}School" ${containerId === 'paymentResult' || containerId === 'exitResult'  ? 'disabled' : 'required'}>
                    <option value="KCPS" ${record.school === 'KCPS' ? 'selected' : ''}>KCPS</option>
                    <option value="DPS" ${record.school === 'DPS' ? 'selected' : ''}>DPS</option>
                    <option value="Inventure" ${record.school === 'Inventure' ? 'selected' : ''}>Inventure</option>
                    <option value="Atmanand" ${record.school === 'Atmanand' ? 'selected' : ''}>Atmanand</option>
                    <option value="Others" ${record.school === 'Others' ? 'selected' : ''}>Others</option>
                </select>
            </div>
            <div class="form-group">
                <label for="${containerId}Date">Enroll Date</label>
                <input type="date" class="form-control" id="${containerId}Date" value="${record.date}" ${containerId === 'paymentResult' || containerId === 'exitResult'  ? 'readonly' : 'required'}>
            </div>
            <div class="form-group">
                <label for="${containerId}Fee">Fee Amount</label>
                <input type="number" class="form-control" id="${containerId}Fee" value="${record.fee}" ${containerId === 'paymentResult' || containerId === 'exitResult' ? 'readonly' : 'required'}>
            </div>
			<div class="form-group">
			    <label for="${containerId}Month">Month</label>
			    <input type="text" class="form-control" id="${containerId}Month" value="${record.month}" 
			           ${containerId === 'paymentResult' || containerId === 'exitResult' || containerId === 'updateResult' ? 'readonly' : 'required'}>
			</div>

            <div class="form-group">
                <label for="${containerId}Payment">Payment Received</label>
                <select class="form-control" id="${containerId}Payment" ${containerId === 'paymentResult' ? 'readonly' : ''} ${containerId === 'exitResult' ? 'disabled' : ''} ${containerId !== 'paymentResult' && containerId !== 'exitResult' ? 'required' : ''}>
                    <option value="No" ${record.payment === 'No' ? 'selected' : ''}>No</option>
                    <option value="Yes" ${record.payment === 'Yes' ? 'selected' : ''}>Yes</option>
                </select>
            </div>
            <button type="submit" class="${buttonClass}">${buttonLabel}</button>
        </form>
    `;

    container.innerHTML = fields;

    document.getElementById(`${containerId}Form`).addEventListener('submit', async function(event) {
        event.preventDefault();
        const paymentField = document.getElementById(`${containerId}Payment`);
        const paymentValue = paymentField.value;

        if (containerId === 'paymentResult' && record.payment === 'Yes') {
            alert("Payment already received");
            return; // Exit the function to avoid making unnecessary API calls
        }

        const updatedRecord = {
            id: record.id,
            name: document.getElementById(`${containerId}Name`).value,
            studentClass: document.getElementById(`${containerId}Class`).value,
            school: document.getElementById(`${containerId}School`).value,
            date: document.getElementById(`${containerId}Date`).value,
            fee: document.getElementById(`${containerId}Fee`).value,
            month: document.getElementById(`${containerId}Month`).value,
            payment: containerId === 'paymentResult' && paymentValue === 'No' ? 'Yes' : paymentValue,
        };

        let endpoint = '';
        if (containerId === 'updateResult') {
            endpoint = '/update';
        } else if (containerId === 'paymentResult') {
            endpoint = '/payment';
        } else if (containerId === 'exitResult') {
            endpoint = '/exit';
        }

        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(updatedRecord),
        });

        const result = await response.json();
        container.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('enrollDate').value = today;

    document.getElementById('enrollMonth').value = new Intl.DateTimeFormat('en-US', { month: 'long' }).format(new Date());
});

	



        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
			document.getElementById('enrollDate').value = today;

            document.getElementById('enrollMonth').value = new Intl.DateTimeFormat('en-US', { month: 'long' }).format(new Date());
        });
    </script>
</body>
</html>
